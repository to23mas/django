<!-- chat/templates/chat/room.html -->
{% extends 'base.html' %}

{% block navigation %}
{% include './chat_navigation.html' %}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto">
        <textarea id="chat-log" 
                  class="w-full h-96 p-4 mb-4 border rounded-lg focus:outline-none focus:border-blue-500 resize-none"
                  readonly></textarea>
        
        <div class="flex gap-4">
            <input id="chat-message-input" 
                   type="text" 
                   class="flex-1 rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:border-blue-500" 
                   placeholder="Type a message...">
            
            <button id="chat-message-submit" 
                    class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 focus:outline-none">
                Send
            </button>
        </div>
    </div>
</div>

{{ room_name|json_script:"room-name" }}

<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const timestamp = new Date().toLocaleTimeString();
        document.querySelector('#chat-log').value += `[${timestamp}] ${data.username}: ${data.message}\n`;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.key === 'Enter') {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        if (message.trim()) {  // Only send if message is not empty
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        }
    };
</script>
{% endblock %}
