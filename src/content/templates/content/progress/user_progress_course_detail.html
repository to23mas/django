{% extends "content/base.html" %}
{% load static %}
{% load progress_tags %}
{% block content %}

<style>
	.section {
		margin-bottom: 30px;
	}
	.section-title {
		font-size: 1.2em;
		margin-bottom: 15px;
		padding-bottom: 5px;
		border-bottom: 1px solid #eee;
	}
	.project-list {
		display: grid;
		grid-template-columns: repeat(5, 1fr);
		gap: 20px;
	}
	.project-item {
		padding: 15px;
		border-radius: 8px;
	}
	.project-item h3 {
		margin: 0;
		font-size: 1.1em;
		margin-bottom: 10px;
	}
	.lesson-list {
		margin-left: 20px;
		margin-top: 10px;
	}
	.lesson-item {
		margin-bottom: 10px;
	}
	.lesson-title {
		font-weight: bold;
		color: #666;
	}
	.chapter-list {
		margin-left: 20px;
		margin-top: 5px;
		display: flex;
		flex-wrap: wrap;
		gap: 5px;
	}
	.chapter-pill {
		padding: 3px 10px;
		border-radius: 15px;
		font-size: 0.9em;
		text-decoration: none;
	}
	.chapter-done {
		background-color: #4CAF50;
		color: white !important;
	}
	.chapter-open { 
		background-color: #FFC107;
		color: black !important;
	}
	.chapter-lock {
		background-color: #9E9E9E;
		color: white !important;
	}
	.test-list {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 20px;
		padding: 20px;
	}
	.test-item {
		background: #1e1e1e;
		border-radius: 12px;
		padding: 20px;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		transition: transform 0.2s, box-shadow 0.2s;
	}
	.test-item:hover {
		transform: translateY(-2px);
		box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
	}
	.test-finish {
		border-left: 4px solid #4CAF50;
	}
	.test-success {
		border-left: 4px solid #2196F3;
	}
	.test-open {
		border-left: 4px solid #FFC107;
	}
	.test-close {
		border-left: 4px solid #9E9E9E;
	}
	.test-fail {
		border-left: 4px solid #fa1212;
	}
	.test-header {
		display: flex;
		flex-direction: column;
		gap: 8px;
		margin-bottom: 15px;
	}
	.test-title {
		font-size: 1.2em;
		font-weight: 600;
		color: #ffffff;
	}
	.test-meta {
		display: flex;
		gap: 15px;
		color: #888;
		font-size: 0.9em;
	}
	.test-meta span {
		display: flex;
		align-items: center;
		gap: 4px;
	}
	.test-description {
		color: #aaa;
		font-size: 0.9em;
		margin: 10px 0;
		line-height: 1.4;
	}
	.test-score {
		margin-top: 15px;
		padding-top: 15px;
		border-top: 1px solid #333;
	}
	.test-score-value {
		font-size: 1.4em;
		font-weight: 600;
		color: #ffffff;
		margin-bottom: 8px;
	}
	.test-progress {
		height: 6px;
		background-color: #333;
		border-radius: 3px;
		margin: 10px 0;
		overflow: hidden;
	}
	.test-progress-bar {
		height: 100%;
		border-radius: 3px;
		transition: width 0.3s ease;
	}
	.test-finish .test-progress-bar { background-color: #4CAF50; }
	.test-success .test-progress-bar { background-color: #2196F3; }
	.test-open .test-progress-bar { background-color: #FFC107; }
	.test-fail .test-progress-bar { background-color: #fa1212; }
	.test-attempts {
		color: #888;
		font-size: 0.9em;
	}
	.not-attempted {
		color: #666;
		font-style: italic;
		text-align: center;
		padding: 20px 0;
	}
</style>

<main id="content-start" class="content" tabindex="-1">
	<div id="content" class="">
		<h1>Progress for {{ user.username }} and {{ c.title }}</h1>
		<div id="content-main">
			<div class="module filtered" id="changelist">
				<div class="changelist-form-container">
					<div class="results">
						<div class="section">
							<div class="section-title">Projects</div>
							<div class="project-list">
								{% for project_id, chapters in progress.chapters.items %}
								<div class="project-item">
									<h3>{% get_project_name c.id project_id %}</h3>
									<div class="lesson-list">
										{% regroup chapters.items by 1.lesson_id as lesson_list %}
										{% for lesson in lesson_list %}
										<div class="lesson-item">
											<span class="lesson-title">Lesson: {% get_lesson_title c.id project_id lesson.grouper %}</span>
											<div class="chapter-list">
												{% for chapter_item in lesson.list %}
												<a href="{% url 'admin_chapter_edit' course_id=c.id project_id=project_id lesson_id=lesson.grouper chapter_id=chapter_item.0 %}"
												   class="chapter-pill chapter-{{ chapter_item.1.status }}">
													{{ chapter_item.0 }}: {% get_chapter_title c.id project_id chapter_item.0 %}
												</a>
												{% endfor %}
											</div>
										</div>
										{% endfor %}
									</div>
								</div>
								{% endfor %}
							</div>
						</div>
						<div class="section">
							<div class="section-title">Tasks</div>
							<div class="project-list">
								{% for project_id, chapters in progress.chapters.items %}
								<div class="project-item">
									<h3>{% get_project_name c.id project_id %}</h3>
									<div class="lesson-list">
										{% regroup chapters.items by 1.lesson_id as lesson_list %}
										{% for lesson in lesson_list %}
										<div class="lesson-item">
											<span class="lesson-title">Lesson: {% get_lesson_title c.id project_id lesson.grouper %}</span>
											<div class="chapter-list">
												{% for chapter_item in lesson.list %}
												<a href="{% url 'admin_chapter_edit' course_id=c.id project_id=project_id lesson_id=lesson.grouper chapter_id=chapter_item.0 %}"
												   class="chapter-pill chapter-{{ chapter_item.1.status }}">
													{{ chapter_item.0 }}: {% get_chapter_title c.id project_id chapter_item.0 %}
												</a>
												{% endfor %}
											</div>
										</div>
										{% endfor %}
									</div>
								</div>
								{% endfor %}
							</div>
						</div>
						<div class="section">
							<div class="section-title">Tests</div>
							<div class="test-list">
								{% for test in tests %}
								{% with user_progress=progress.tests|find_test_progress:test.id %}
								<div class="test-item test-{{ user_progress.state|default:'close' }}">
									<div class="test-header">
										<div class="test-title"><a href="{% url 'admin_test_edit' course_id=c.id test_id=test.id %}">{{ test.title }}</a></div>
										<div class="test-meta">
											<span>‚è±Ô∏è {{ test.time }} min</span>
											<span>üìä {{ test.success_score }}%</span>
											<span>‚≠ê {{ test.total_points }} points</span>
										</div>
										<div class="test-description">{{ test.description }}</div>
									</div>
									<div class="test-score">
										{% if user_progress %}
											{% with max_score=user_progress.score|max_value %}
											<div class="test-score-value">
												Score: {{ max_score }}/{{ test.total_points }}
											</div>
											<div class="test-progress">
												<div class="test-progress-bar" style="width: {% widthratio max_score test.total_points 100 %}%"></div>
											</div>
											<div class="test-attempts">
												Attempts: {{ user_progress.attempts }}
											</div>
											{% endwith %}
										{% else %}
											<div class="not-attempted">Not attempted yet</div>
										{% endif %}
									</div>
								</div>
								{% endwith %}
								{% endfor %}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</main>
{% endblock %}
